/*
 * ssd1306_oled.h
 *
 *  Created on: 28-Dec-2025
 *      Author: anees
 */

#include "ssd1306_oled.h"

/* Basic 5x7 font (ASCII 32–127) – minimal subset shown */
static const uint8_t Font5x7[][5] =
{
    {0x00,0x00,0x00,0x00,0x00}, // space
    {0x00,0x00,0x5F,0x00,0x00}, // !
    {0x00,0x07,0x00,0x07,0x00}, // "
    /* extend as needed */
};

static void delay(void)
{
    for (volatile uint32_t i = 0; i < 50000; i++);
}

void OLED_SendCommand(OLED_Handle_t *pOLED, uint8_t cmd)
{
    uint8_t buffer[2];
    buffer[0] = SSD1306_CMD;
    buffer[1] = cmd;

    I2C_MasterSendData(pOLED->pI2CHandle,
                       buffer,
                       2,
                       pOLED->I2C_Address,
                       I2C_DISABLE_SR);
}

void OLED_SendData(OLED_Handle_t *pOLED, uint8_t *data, uint16_t size)
{
    uint8_t buffer[129];
    buffer[0] = SSD1306_DATA;

    for (uint16_t i = 0; i < size; i++)
        buffer[i + 1] = data[i];

    I2C_MasterSendData(pOLED->pI2CHandle,
                       buffer,
                       size + 1,
                       pOLED->I2C_Address,
                       I2C_DISABLE_SR);
}

void OLED_Init(OLED_Handle_t *pOLED)
{
    delay();

    OLED_SendCommand(pOLED, 0xAE); // Display OFF
    OLED_SendCommand(pOLED, 0x20); // Memory mode
    OLED_SendCommand(pOLED, 0x00); // Horizontal
    OLED_SendCommand(pOLED, 0xB0); // Page start
    OLED_SendCommand(pOLED, 0xC8); // COM scan
    OLED_SendCommand(pOLED, 0x00); // Low column
    OLED_SendCommand(pOLED, 0x10); // High column
    OLED_SendCommand(pOLED, 0x40); // Start line
    OLED_SendCommand(pOLED, 0x81); // Contrast
    OLED_SendCommand(pOLED, 0x7F);
    OLED_SendCommand(pOLED, 0xA1); // Segment remap
    OLED_SendCommand(pOLED, 0xA6); // Normal display
    OLED_SendCommand(pOLED, 0xA8); // Multiplex
    OLED_SendCommand(pOLED, 0x3F);
    OLED_SendCommand(pOLED, 0xA4); // Display RAM
    OLED_SendCommand(pOLED, 0xD3); // Offset
    OLED_SendCommand(pOLED, 0x00);
    OLED_SendCommand(pOLED, 0xD5); // Clock
    OLED_SendCommand(pOLED, 0x80);
    OLED_SendCommand(pOLED, 0xD9); // Precharge
    OLED_SendCommand(pOLED, 0xF1);
    OLED_SendCommand(pOLED, 0xDA); // COM pins
    OLED_SendCommand(pOLED, 0x12);
    OLED_SendCommand(pOLED, 0xDB); // VCOM
    OLED_SendCommand(pOLED, 0x40);
    OLED_SendCommand(pOLED, 0x8D); // Charge pump
    OLED_SendCommand(pOLED, 0x14);
    OLED_SendCommand(pOLED, 0xAF); // Display ON

    OLED_Clear(pOLED);
}

void OLED_Clear(OLED_Handle_t *pOLED)
{
    uint8_t zero[SSD1306_WIDTH] = {0};

    for (uint8_t page = 0; page < SSD1306_PAGES; page++)
    {
        OLED_SetCursor(pOLED, page, 0);
        OLED_SendData(pOLED, zero, SSD1306_WIDTH);
    }
}

void OLED_SetCursor(OLED_Handle_t *pOLED, uint8_t page, uint8_t column)
{
    OLED_SendCommand(pOLED, 0xB0 + page);
    OLED_SendCommand(pOLED, 0x00 + (column & 0x0F));
    OLED_SendCommand(pOLED, 0x10 + (column >> 4));
}

void OLED_WriteChar(OLED_Handle_t *pOLED, char ch)
{
    if (ch < 32 || ch > 127)
        ch = ' ';

    OLED_SendData(pOLED, (uint8_t *)Font5x7[ch - 32], 5);

    uint8_t space = 0x00;
    OLED_SendData(pOLED, &space, 1);
}

void OLED_WriteString(OLED_Handle_t *pOLED, char *str)
{
    while (*str)
    {
        OLED_WriteChar(pOLED, *str++);
    }
}
