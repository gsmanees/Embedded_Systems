/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

/**
 ******************************************************************************
 * @file           : main.c
 * @brief          : SWV + ITM working example for button + LED
 ******************************************************************************
 */

/**
 ******************************************************************************
 * @file           : main.c
 * @brief          : SWV ITM + Button + LED Example (No printf)
 ******************************************************************************
 */

#include "stm32f446xx.h"
#include <stdint.h>

#define LED_PIN     5
#define BUTTON_PIN  13

/* Simple delay */
void delay_ms(uint32_t ms)
{
    volatile uint32_t i;
    while (ms--)
        for (i = 0; i < 4000; i++);
}

int main(void)
{
    /* -------- Enable GPIO clocks -------- */
    RCC->AHB1ENR |= (1 << 0);   // GPIOA clock enable
    RCC->AHB1ENR |= (1 << 2);   // GPIOC clock enable

    /* -------- Configure PA5 (LED) as output -------- */
    GPIOA->MODER &= ~(0x3 << (LED_PIN * 2));  // Clear mode bits
    GPIOA->MODER |=  (0x1 << (LED_PIN * 2));  // Output mode
    GPIOA->OTYPER &= ~(1 << LED_PIN);         // Push-pull
    GPIOA->OSPEEDR |= (1 << (LED_PIN * 2));   // Medium speed
    GPIOA->PUPDR &= ~(0x3 << (LED_PIN * 2));  // No pull-up/down
    GPIOA->ODR &= ~(1 << LED_PIN);            // LED OFF

    /* -------- Configure PC13 (Button) as input -------- */
    GPIOC->MODER &= ~(0x3 << (BUTTON_PIN * 2));  // Input mode

    /* -------- Enable ITM + SWO -------- */
    CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;   // Enable debugging
    ITM->LAR = 0xC5ACCE55;                             // Unlock ITM
    ITM->TCR = ITM_TCR_ITMENA_Msk | ITM_TCR_SWOENA_Msk | ITM_TCR_TSENA_Msk;
    ITM->TER |= (1 << 0);                              // Enable Port 0

    ITM_SendChar('S');   // Send "Start" indicator to SWV

    /* -------- Main Loop -------- */
    while (1)
    {
        if (!(GPIOC->IDR & (1 << BUTTON_PIN)))   // Button pressed (active LOW)
        {
            GPIOA->ODR |= (1 << LED_PIN);        // LED ON
            ITM_SendChar('P');                   // Send 'P' = Pressed
            delay_ms(200);
        }
        else
        {
            GPIOA->ODR &= ~(1 << LED_PIN);       // LED OFF
            ITM_SendChar('R');                   // Send 'R' = Released
            delay_ms(200);
        }
    }
}
