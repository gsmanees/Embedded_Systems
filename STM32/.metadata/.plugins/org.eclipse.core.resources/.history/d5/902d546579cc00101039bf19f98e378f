/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

/**
 ******************************************************************************
 * @file           : main.c
 * @brief          : SWV + ITM working example for button + LED
 ******************************************************************************
 */

#include "stm32_f446xx.h"
#include <stdint.h>
#include <stdio.h>

#define LED_PIN     5
#define BUTTON_PIN  13

/* ---------- SWV printf redirection ---------- */
int _write(int file, char *ptr, int len)
{
    for (int i = 0; i < len; i++)
    {
        ITM_SendChar(*ptr++);
    }
    return len;
}

/* ---------- Delay ---------- */
void delay_ms(uint32_t ms)
{
    volatile uint32_t count;
    while (ms--)
    {
        for (count = 0; count < 4000; count++)
            __asm__("nop");
    }
}

int main(void)
{
    /* ----- Enable clocks for GPIOA + GPIOC ----- */
    RCC->AHB1ENR |= (1 << 0);   // GPIOA clock
    RCC->AHB1ENR |= (1 << 2);   // GPIOC clock

    /* ----- Configure PA5 as output ----- */
    GPIOA->MODER &= ~(0x3 << (LED_PIN * 2));
    GPIOA->MODER |=  (0x1 << (LED_PIN * 2));    // Output mode
    GPIOA->OTYPER &= ~(1 << LED_PIN);           // Push-pull
    GPIOA->OSPEEDR |= (0x1 << (LED_PIN * 2));   // Medium speed
    GPIOA->PUPDR &= ~(0x3 << (LED_PIN * 2));    // No pull
    GPIOA->ODR &= ~(1 << LED_PIN);              // LED OFF

    /* ----- Configure PC13 as input ----- */
    GPIOC->MODER &= ~(0x3 << (BUTTON_PIN * 2)); // Input mode

    /* ---------- Enable ITM + SWO ---------- */
    CoreDebug->DEMCR |= CoreDebug_DEMCR_TRCENA_Msk;  // Enable debugging
    ITM->LAR  = 0xC5ACCE55;                           // Unlock ITM
    ITM->TCR  = ITM_TCR_ITMENA_Msk |                 // Enable ITM
                ITM_TCR_TSENA_Msk  |                 // Enable timestamps
                ITM_TCR_SWOENA_Msk;                  // Enable SWO
    ITM->TER |= (1 << 0);                             // Enable Port 0

    printf("SWV ITM Test Started...\n");

    /* ---------- Main Loop ---------- */
    while (1)
    {
        if (!(GPIOC->IDR & (1 << BUTTON_PIN)))   // Button pressed (active LOW)
        {
            GPIOA->ODR |= (1 << LED_PIN);
            printf("Button Pressed\n");
            delay_ms(300);
        }
        else
        {
            GPIOA->ODR &= ~(1 << LED_PIN);
            printf("Button Released\n");
            delay_ms(300);
        }
    }
}
